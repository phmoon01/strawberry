---
title: "Testing Strawberries"
output: html_document
date: "2024-10-11"
---

```{r setup, include = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
#| label: load libraries and set options

library(knitr)
library(kableExtra)
library(tidyverse)
library(stringr)

options(echo = FALSE, digits = 3, scipen = 999)
```

```{r, message = FALSE}
strawberry <- read_csv("strawberries25_v3.csv", col_names = TRUE)
```

```{r}
#| label: explore organization 1 

## Is every line associated with a state?

state_all <- strawberry |> distinct(State)

state_all1 <- strawberry |> group_by(State) |> count()

## every row is associated with a state

if(sum(state_all1$n) == dim(strawberry)[1]){print("Yes every row in the data is associated with a state.")}

## rm(state_all, state_all1)
```

```{r}
#|label: function def - drop 1-item columns

# Define a function to drop columns that contain only one unique value
drop_one_value_col <- function(df){
  drop <- NULL  # Initialize an empty vector to keep track of columns to drop
  
  # Loop through each column in the dataframe
  for(i in 1:dim(df)[2]){
    # Check if the current column has only one unique value
    if((df |> distinct(df[, i]) |> count()) == 1){
      drop = c(drop, i)  # Add the index of the column to the 'drop' vector
    }
  }
  
  # If no columns were found to drop, return "none"
  if(is.null(drop)){
    return("none")  # Return "none" if no columns are to be dropped
  }
  else{
    print("Columns dropped:")  # Print a message indicating columns will be dropped
    print(colnames(df)[drop])  # Print the names of the columns that are being dropped
    strawberry <- df[, -1 * drop]  # Remove the identified columns from the dataframe
  }
}

# Apply the function to the 'strawberry' dataframe to drop one-value columns
strawberry <- drop_one_value_col(strawberry)

# Call the function again on the updated 'strawberry' dataframe
drop_one_value_col(strawberry)
```

```{r}
#| label: ditch the counties

# Get unique values in the 'Geo Level' column of the 'strawberry' dataframe
unique(strawberry$`Geo Level`)

# Filter the 'strawberry' dataframe to keep only rows where 'Geo Level' is either "NATIONAL" or "STATE"
strawberry <- strawberry |> filter(`Geo Level` == "NATIONAL" | `Geo Level` == "STATE")
```

```{r}
#| label: srawberries split census, survey

# Filter the 'strawberry' dataframe to create a new dataframe 'straw_cen' containing only rows where Program is "CENSUS"
straw_cen <- strawberry |> filter(Program == "CENSUS")

# Apply the 'drop_one_value_col' function to the 'straw_cen' dataframe to remove columns with only one unique value
straw_cen <- straw_cen |> drop_one_value_col()

# Filter the 'strawberry' dataframe to create a new dataframe 'straw_sur' containing only rows where Program is "SURVEY"
straw_sur <- strawberry |> filter(Program == "SURVEY")

# Apply the 'drop_one_value_col' function to the 'straw_sur' dataframe to remove columns with only one unique value
straw_sur <- straw_sur %>% drop_one_value_col()

# Check if the total number of rows in the original dataframe equals the sum of the rows in 'straw_sur' and 'straw_cen'
nrow(strawberry) == (nrow(straw_sur) + nrow(straw_cen))
```

```{r, warning = FALSE}
# Modify the 'straw_sur' dataframe using a series of transformations
straw_sur <- straw_sur %>%
  # Replace the content of 'Domain Category' with a new format using gsub
  mutate(`Domain Category` = gsub(".*: \\(([^=]+) = ([0-9]+)\\)", "\\1,\\2", `Domain Category`)) %>%
  
  # Separate the 'Domain Category' into two new columns: 'Chemical' and 'Number'
  separate(`Domain Category`, into = c("Chemical", "Number"), sep = ",") %>%
  
  # Trim whitespace from the 'Chemical' column and convert 'Number' to numeric after trimming
  mutate(Chemical = trimws(Chemical),     # Remove leading/trailing whitespace from Chemical
         Number = as.numeric(trimws(Number)))  # Convert Number to numeric after trimming
```

```{r, warning = FALSE}
# Modify the 'straw_sur' dataframe to separate the 'Domain' column into two new columns: 'Domain' and 'use'
straw_sur <- straw_sur %>%
  separate(Domain, into = c("Domain", "use"), sep = ",", extra = "merge")
```

```{r}
# Modify the 'straw_sur' dataframe using a series of transformations
straw_sur <- straw_sur %>%
  # Extract the measurement information from the 'Data Item' column using a regex pattern
  mutate(measurement = str_extract(`Data Item`, "(?<=MEASURED\\s).*")) %>%
  
  # Remove the 'MEASURED' text and everything after it from the 'Data Item' column
  mutate(`Data Item` = str_remove(`Data Item`, "MEASURED.*")) %>%
  
  # Separate the 'Data Item' into two new columns: 'Data Item' and 'category'
  separate(`Data Item`, into = c("Data Item", "category"), sep = "[,-]", extra = "merge", fill = "right")

# Select specific columns from the 'straw_sur' dataframe
straw_sur <- straw_sur %>%
  select(1:7, 13, 8:12)

# Further modify the 'measurement' column
straw_sur <- straw_sur %>%
  # Remove the word 'IN' from the 'measurement' column
  mutate(measurement = gsub("\\bIN\\b", "", measurement)) %>%
  
  # Trim whitespace from the 'measurement' column
  mutate(measurement = trimws(measurement))

# Select specific columns from the 'straw_sur' dataframe again
straw_sur <- straw_sur %>%
  select(1:8, 13, 9:12)
```

```{r}
# Remove the 'Data Item' column from the 'straw_sur' dataframe
straw_sur <- straw_sur %>%
  select(-`Data Item`)

# Remove any commas from the 'category' column in the 'straw_sur' dataframe
straw_sur$category <- gsub(",", "", straw_sur$category)
```

```{r}
# Filter the 'straw_sur' dataframe to create a new dataframe 'sur_total' containing only rows where Domain is "TOTAL"
sur_total <- straw_sur %>% filter(Domain == "TOTAL")

# Filter the 'straw_sur' dataframe to create a new dataframe 'sur_chem' containing only rows where Domain is "CHEMICAL"
sur_chem <- straw_sur %>% filter(Domain == "CHEMICAL")

# Apply the 'drop_one_value_col' function to the 'sur_total' dataframe to remove columns with only one unique value
sur_total = drop_one_value_col(sur_total)

# Apply the 'drop_one_value_col' function to the 'sur_chem' dataframe to remove columns with only one unique value
sur_chem = drop_one_value_col(sur_chem)
```

```{r}
#| label: straw_cen split cols

# Modify the 'straw_cen' dataframe by separating the 'Data Item' column into two new columns: 'strawberries' and 'Category'
straw_cen <- straw_cen |>
  separate_wider_delim(cols = `Data Item`, delim = " - ", 
                       names = c("strawberries", "Category"), 
                       too_many = "error", too_few = "align_start")
```

```{r}
#| label: isolate organic


# Modify the 'straw_cen' dataframe by separating the 'strawberries' column into three new columns: 'strawberries', 'ORGANIC', and 'organic_detail'
straw_cen <- straw_cen |>
  separate_wider_delim(cols = strawberries, delim = ", ",
                       names = c("strawberries", "ORGANIC", "organic_detail"), 
                       too_many = "error", too_few = "align_start")

# Apply the 'drop_one_value_col' function to the 'straw_cen' dataframe to remove columns with only one unique value
straw_cen <- straw_cen |> drop_one_value_col()

# Filter the 'straw_cen' dataframe to create a new dataframe 'organic_cen' containing only rows where ORGANIC is "ORGANIC"
organic_cen <- straw_cen |> filter(ORGANIC == "ORGANIC")

# Calculate the number of NA values in the 'ORGANIC' column of the 'straw_cen' dataframe
sum(is.na(straw_cen$ORGANIC))

# Keep only rows in 'straw_cen' where the 'ORGANIC' column is NA
straw_cen <- straw_cen[(is.na(straw_cen$ORGANIC)), ]

# Apply the 'drop_one_value_col' function again to the updated 'straw_cen' dataframe
straw_cen <- straw_cen |> drop_one_value_col()
```

```{r}
#| label: explore straw_cen$Category

# Modify the 'straw_cen' dataframe by separating the 'Category' column into two new columns: 'COL1' and 'COL2'
straw_cen <- straw_cen |>
  separate_wider_delim(cols = `Category`, delim = " ", 
                       names = c("COL1", "COL2"),
                       too_many = "merge", too_few = "align_start")

# Remove the word "WITH" from the 'COL2' column
straw_cen$COL2 <- str_replace(straw_cen$COL2, "WITH ", "")

# Rename the columns 'COL1' and 'COL2' to 'Measure' and 'Bearing_type' respectively
straw_cen <- straw_cen |> rename(Measure = COL1, Bearing_type = COL2)
```

```{r}
#| label: explore straw_cen$Domain & Domain Category

# Rename the 'Domain Category' column to 'size_bracket' in the 'straw_cen' dataframe
straw_cen <- straw_cen |> rename(size_bracket = `Domain Category`)

# Replace occurrences of "NOT SPECIFIED" in the 'size_bracket' column with "TOTAL"
straw_cen$size_bracket <- str_replace(straw_cen$size_bracket, "NOT SPECIFIED", "TOTAL")

# Remove the text "AREA GROWN: " from the 'size_bracket' column
straw_cen$size_bracket <- str_replace(straw_cen$size_bracket, "AREA GROWN: ", "")
```

```{r}
# Apply the 'drop_one_value_col' function to the 'organic_cen' dataframe to remove columns with only one unique value
organic_cen <- organic_cen |> drop_one_value_col()

# Separate the 'Category' column into two new columns: 'Category' and 'measurement' using the delimiter " MEASURED "
organic_cen <- organic_cen %>%
  separate(Category, into = c("Category", "measurement"), sep = " MEASURED ", extra = "merge", fill = "right")

# Remove any commas from the 'Category' column in the 'organic_cen' dataframe
organic_cen$Category <- gsub(",", "", organic_cen$Category)

# Remove the word "IN" from the 'measurement' column, ignoring case
organic_cen$measurement <- gsub("IN", "", organic_cen$measurement, ignore.case = TRUE)
```

```{r}
# Create a new dataframe 'no_NA' by modifying 'straw_cen':
no_NA <- straw_cen |> 
  # Replace "(D)" and "(Z)" in the 'Value' column with NA
  mutate(Value = na_if(Value, "(D)"), 
         Value = na_if(Value, "(Z)"),
         # Remove commas from 'Value' and convert it to numeric
         Value = as.numeric(gsub(",", "", Value))) |> 
  # Remove rows with NA values from the dataframe
  na.omit()

# Fit a linear model 'fit1' predicting 'Value' based on 'Measure', 'Bearing_type', 'State', and 'size_bracket'
fit1 <- lm(Value ~ Measure + Bearing_type + State + size_bracket, data = no_NA)
```

```{r}
#|label: listing out the data frames

print(head(strawberry))
print(head(straw_cen))
print(head(sur_chem))
print(head(sur_total))
print(head(organic_cen))
```

```{r}
#|label: Count of Organic Strawberry Operations by State Plot 

# Count of organic operations by state
state_counts <- organic_cen %>%
  group_by(State) %>%
  summarize(Count = n())

ggplot(state_counts, aes(x = reorder(State, Count), y = Count)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "States", y = "Count of Organic Strawberry Operations",
       title = "Count of Organic Strawberry Operations by State")
```

```{r, warning = FALSE}
#|label: showing every number in numerical order

# Adjust the column names based on your findings
chemical_summary <- sur_chem %>%
  group_by(Chemical) %>%
  summarize(Total_Number = sum(Number, na.rm = TRUE), .groups = "drop") %>%  
  arrange(Total_Number)  

# Print the summary
print(chemical_summary)
```